<script setup>
import Desk from "@/components/Desk.vue";
</script>
<template>
  <svg
    width="1800.0000000000002"
    height="900.0000000000001"
    xmlns="http://www.w3.org/2000/svg"
  >
    <defs>
      <filter id="svg_21_blur">
        <feGaussianBlur in="SourceGraphic" stdDeviation="0" />
      </filter>
    </defs>

    <title>Layer 1</title>
    <line
      stroke="#000"
      fill="none"
      x1="17"
      y1="816.10694"
      x2="17"
      y2="869.08081"
      id="svg_5"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <line
      stroke="#000"
      fill="none"
      x1="1769.58817"
      y1="53.85561"
      x2="1769.58817"
      y2="252.27831"
      id="svg_19"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <text
      fill="#000000"
      stroke="#000"
      x="74.15007"
      y="122.58248"
      id="svg_88"
      stroke-width="0"
      font-size="24"
      font-family="Noto Sans JP"
      text-anchor="start"
      xml:space="preserve"
    >
      Bathroom
    </text>
    <line
      fill="none"
      x1="453.45909"
      y1="336.35961"
      x2="453.45909"
      y2="52.61646"
      id="svg_261"
      stroke="#000"
    />
    <line
      stroke="#000"
      fill="none"
      x1="17.08416"
      y1="810.1174"
      x2="17.08416"
      y2="248.30012"
      id="svg_601"
      stroke-dasharray="5,5"
    />
    <line
      stroke="#000"
      fill="none"
      x1="1771.01674"
      y1="332.60391"
      x2="1771.01674"
      y2="395.33181"
      id="svg_607"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <line
      fill="none"
      x1="16.91594"
      y1="52.33351"
      x2="525.5764"
      y2="52.33351"
      id="svg_809"
      stroke="#000"
    />
    <line
      fill="none"
      x1="990.31607"
      y1="52.3674"
      x2="532.45095"
      y2="52.3674"
      id="svg_1031"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      stroke="#000"
      fill="none"
      x1="1504.38812"
      y1="52.53678"
      x2="1769.84474"
      y2="52.53678"
      id="svg_1032"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <line
      fill="none"
      x1="76.14114"
      y1="870.66494"
      x2="513.97686"
      y2="870.66494"
      id="svg_1177"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      stroke="#000"
      fill="none"
      x1="17.35135"
      y1="869.3908"
      x2="70.56305"
      y2="869.3908"
      id="svg_1178"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <line
      stroke="#000"
      fill="none"
      x1="17.26695"
      y1="53.85356"
      x2="17.26695"
      y2="247.83524"
      id="svg_1"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <line
      fill="none"
      x1="515.33318"
      y1="871.08351"
      x2="633.82739"
      y2="871.08351"
      id="svg_60"
      stroke="#000"
    />
    <line
      fill="none"
      x1="573.11524"
      y1="586.70363"
      x2="628.2434"
      y2="586.70363"
      id="svg_61"
      stroke="#000"
    />
    <line
      fill="none"
      x1="637.64239"
      y1="870.66494"
      x2="1101.64455"
      y2="870.66494"
      id="svg_443"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      stroke="#000"
      fill="none"
      x1="996.61452"
      y1="53.37161"
      x2="1085.91066"
      y2="53.37161"
      id="svg_444"
    />
    <line
      stroke="#000"
      fill="none"
      x1="18.24929"
      y1="189.83351"
      x2="236.91021"
      y2="189.83351"
      id="svg_445"
    />
    <line
      stroke="#000"
      fill="none"
      x1="238.51695"
      y1="53.85356"
      x2="238.51695"
      y2="94.0818"
      id="svg_446"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <line
      stroke="#000"
      fill="none"
      x1="238.51695"
      y1="150.10356"
      x2="238.51695"
      y2="190.3318"
      id="svg_447"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
    />
    <text
      fill="#000000"
      stroke="#000"
      x="1605.40007"
      y="122.58248"
      id="svg_548"
      stroke-width="0"
      font-size="24"
      font-family="Noto Sans JP"
      text-anchor="start"
      xml:space="preserve"
    >
      Bathroom
    </text>
    <line
      fill="none"
      x1="1720.16552"
      y1="189.83351"
      x2="1768.16017"
      y2="189.83351"
      id="svg_549"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1548.51695"
      y1="53.85356"
      x2="1548.51695"
      y2="187.4149"
      id="svg_550"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1106.66567"
      y1="871.08351"
      x2="1769.15865"
      y2="871.08351"
      id="svg_552"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1770.83416"
      y1="781.1176"
      x2="1770.83416"
      y2="401.21218"
      id="svg_887"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1040.12432"
      y1="336.35961"
      x2="1040.12432"
      y2="52.61646"
      id="svg_3"
      stroke="#000"
    />
    <line
      fill="none"
      x1="573.4588"
      y1="869.69163"
      x2="573.4588"
      y2="585.94848"
      id="svg_6"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1160.12402"
      y1="869.69163"
      x2="1160.12402"
      y2="585.94848"
      id="svg_22"
      stroke="#000"
    />
    <line
      fill="none"
      x1="710.44823"
      y1="586.70363"
      x2="1158.90871"
      y2="586.70363"
      id="svg_23"
      stroke="#000"
    />
    <line
      fill="none"
      x1="453.11554"
      y1="336.03758"
      x2="508.2437"
      y2="336.03758"
      id="svg_24"
      stroke="#000"
    />
    <line
      fill="none"
      x1="590.44852"
      y1="336.03758"
      x2="1038.90901"
      y2="336.03758"
      id="svg_25"
      stroke="#000"
    />
    <line
      stroke="#000"
      fill="none"
      x1="1494.31483"
      y1="52.3674"
      x2="1088.78282"
      y2="52.3674"
      id="svg_153"
      stroke-dasharray="5,5"
    />
    <line
      fill="none"
      x1="1549.49925"
      y1="189.83351"
      x2="1657.49372"
      y2="189.83351"
      id="svg_395"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1771.01674"
      y1="785.93613"
      x2="1771.01674"
      y2="872.66397"
      id="svg_426"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <g id="meeting_room">
      <rect
        fill="#f2efef"
        x="560.00683"
        y="110.73969"
        width="372.78446"
        height="168.28551"
        id="svg_4"
        rx="8"
        stroke="#000"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="689.47008"
        y="136.19365"
        width="115.55446"
        height="115.55446"
        id="svg_48"
        rx="8"
      />
      <rect
        :fill="
          occupiedDesks.includes('103ef45c-ee00-433f-aa62-6a298afe32ec') ||
          userType !== 'BUSINESS'
            ? 'red'
            : 'green'
        "
        x="693.17375"
        y="139.89732"
        width="108.14713"
        height="108.14713"
        id="svg_49"
        rx="8"
        stroke="#000"
        data-id="103ef45c-ee00-433f-aa62-6a298afe32ec"
        @click="handleMeetingRoomClick"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="534.22853"
        y="164.31971"
        width="24.99986"
        height="48.74973"
        id="svg_53"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="933.39397"
        y="169.1598"
        width="24.99986"
        height="48.74973"
        id="svg_54"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="610.85662"
        y="88.89111"
        width="43.74976"
        height="21.24988"
        id="svg_431"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="685.85621"
        y="88.89111"
        width="43.74976"
        height="21.24988"
        id="svg_432"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="759.23462"
        y="89.71876"
        width="43.74976"
        height="21.24988"
        id="svg_433"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="834.23462"
        y="89.71876"
        width="43.74976"
        height="21.24988"
        id="svg_434"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="616.18994"
        y="279.22453"
        width="43.74976"
        height="21.24988"
        id="svg_438"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="691.18953"
        y="279.22453"
        width="43.74976"
        height="21.24988"
        id="svg_439"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="764.56794"
        y="278.71885"
        width="43.74976"
        height="21.24988"
        id="svg_440"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="839.56794"
        y="278.71885"
        width="43.74976"
        height="21.24988"
        id="svg_441"
        rx="8"
      />
    </g>
    <g id="meeting_room">
      <rect
        fill="#f2efef"
        x="681.33986"
        y="644.07172"
        width="372.78446"
        height="168.28551"
        id="svg_7"
        rx="8"
        stroke="#000"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="810.80312"
        y="669.52567"
        width="115.55446"
        height="115.55446"
        id="svg_8"
        rx="8"
      />
      <rect
        :fill="
          occupiedDesks.includes('fda6463e-96d3-4eb1-9e62-1fcbf8b99d38') ||
          userType !== 'BUSINESS'
            ? 'red'
            : 'green'
        "
        x="814.50679"
        y="673.22934"
        width="108.14713"
        height="108.14713"
        id="svg_9"
        rx="8"
        stroke="#000"
        data-id="fda6463e-96d3-4eb1-9e62-1fcbf8b99d38"
        @click="handleMeetingRoomClick"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="655.56156"
        y="697.65173"
        width="24.99986"
        height="48.74973"
        id="svg_10"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1054.72701"
        y="702.49182"
        width="24.99986"
        height="48.74973"
        id="svg_11"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="732.18965"
        y="622.22313"
        width="43.74976"
        height="21.24988"
        id="svg_12"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="807.18924"
        y="622.22313"
        width="43.74976"
        height="21.24988"
        id="svg_13"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="880.56765"
        y="623.05078"
        width="43.74976"
        height="21.24988"
        id="svg_14"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="955.56765"
        y="623.05078"
        width="43.74976"
        height="21.24988"
        id="svg_15"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="737.52297"
        y="812.55655"
        width="43.74976"
        height="21.24988"
        id="svg_16"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="812.52256"
        y="812.55655"
        width="43.74976"
        height="21.24988"
        id="svg_17"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="885.90097"
        y="812.05087"
        width="43.74976"
        height="21.24988"
        id="svg_18"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="960.90097"
        y="812.05087"
        width="43.74976"
        height="21.24988"
        id="svg_20"
        rx="8"
      />
    </g>
    <Desk
      v-for="desk in desks"
      :desk="desk"
      @deskClicked="$emit('deskClicked', $event)"
      :isOccupied="occupiedDesks.includes(desk.id)"
      :hasRequests="filteredDesks.includes(desk.id)"
    ></Desk>
  </svg>
</template>
<script>
/**
 * Component for displaying a specific floor layout within a building.
 * This component renders an interactive SVG diagram of a floor with desks and meeting rooms,
 * allowing users to view and select workstations or meeting rooms for booking.
 *
 * Features:
 * - Renders a detailed SVG floor plan based on provided floor data.
 * - Supports interactive selection of desks and meeting rooms.
 * - Highlights desks based on occupancy and specific user requests like equipment needs or window preference.
 * - Emits events for desk or room selection to facilitate booking actions in parent components.
 *
 * Props:
 * @vue-prop {Object} floorInfo - Contains details about the floor, including IDs and structural data.
 * @vue-prop {Array} occupiedDesks - A list of desk IDs that are currently occupied.
 * @vue-prop {String} userType - The type of the user, which influences access levels to certain areas like meeting rooms.
 * @vue-prop {String|null} equipment - Specifies equipment requirements for filtering desks.
 * @vue-prop {Boolean|null} hasWindow - Specifies if the desk should have a window based on user preference.
 *
 * Data:
 * @vue-data {Array} desks - Stores the list of desks on the current floor as retrieved from the server.
 * @vue-data {Array} filteredDesks - Stores desks that meet specific criteria like equipment and window preferences.
 *
 * Watchers:
 * - Watches `equipment` and `hasWindow` properties to re-filter the desks whenever these preferences change.
 *
 * Usage:
 * Embed this component in any part of the application where an interactive floor plan is needed for desk booking.
 * Ensure that the parent component manages state such as user type and booking preferences to pass them as props.
 *
 * @subcategory components / Building 3
 */

export default {
  props: {
    floorInfo: {
      type: Object,
      required: true,
    },
    occupiedDesks: {
      type: Array,
    },
    userType: {
      type: String,
    },
    equipment: {
      type: String,
    },
    hasWindow: {
      type: Boolean,
    },
  },
  data() {
    return {
      desks: [],
      filteredDesks: [],
    };
  },
  beforeMount() {
    this.getDesks();
    this.getFilteredDesks();
  },
  methods: {
    /**
     * Fetches and filters the desks on the current floor based on the type "desk".
     * This method makes an API call to retrieve a list of all workstations on the current floor and filters out those
     * which are specifically designated as desks. It updates the `desks` data property with these filtered results.
     */
    getDesks() {
      this.$ApiService
        .get_workstations(this.floorInfo.floorId, this.floorInfo.buildingId)
        .then((response) => {
          this.desks = response.data.workStationResourceList.filter(
            (desk) => desk.type === "desk",
          );
        });
    },
    /**
     * Filters desks based on user-specified equipment and window preferences.
     * This method is triggered whenever the `equipment` or `hasWindow` props change. It performs an API call
     * to fetch workstations that meet the specified criteria. If no equipment is specified, it filters based on the
     * window preference alone. The results are used to update the `filteredDesks` data property.
     */
    getFilteredDesks() {
      this.$ApiService
        .get_workstations(
          this.floorInfo.floorId,
          this.floorInfo.buildingId,
          this.equipment,
          this.hasWindow,
        )
        .then((response) => {
          if (this.equipment === null) {
            response.data.workStationResourceList =
              response.data.workStationResourceList.filter((desk) => {
                if (this.hasWindow !== null)
                  return desk.presentWindow === this.hasWindow;
                else return false;
              });
          }
          this.filteredDesks = response.data.workStationResourceList.map(
            (desk) => desk.id,
          );
        });
    },
    /**
     * Handles user interactions with meeting rooms within the SVG floor plan.
     * When a meeting room is clicked, this method checks if the user type is allowed to book meeting rooms
     * (e.g., 'BUSINESS' users). It emits an `deskClicked` event with the meeting room's ID if the room is available
     * and the user is permitted, allowing the parent component to process the booking.
     *
     * @param {Event} event - The DOM event triggered when a meeting room element in the SVG is clicked.
     */
    handleMeetingRoomClick(event) {
      if (this.userType === "BUSINESS") {
        const meetingRoomId = event.target.getAttribute("data-id");
        if (meetingRoomId && !this.occupiedDesks.includes(meetingRoomId)) {
          this.$emit("deskClicked", meetingRoomId);
        }
      }
    },
  },
  watch: {
    equipment: "getFilteredDesks",
    hasWindow: "getFilteredDesks",
  },
};
</script>
