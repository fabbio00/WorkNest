<script setup>
import Desk from "@/components/DeskComponent.vue";
</script>
<template>
  <svg
    width="1800.0000000000002"
    height="900.0000000000001"
    xmlns="http://www.w3.org/2000/svg"
  >
    <defs>
      <filter id="svg_21_blur">
        <feGaussianBlur in="SourceGraphic" stdDeviation="0" />
      </filter>
    </defs>

    <title>Layer 1</title>
    <line
      fill="none"
      x1="17"
      y1="841.10727"
      x2="17"
      y2="869.08081"
      id="svg_5"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="413.29732"
      y1="869.3908"
      x2="721.84687"
      y2="869.3908"
      id="svg_7"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="18.62617"
      y1="227.32434"
      x2="229.28099"
      y2="227.32434"
      id="svg_256"
      stroke="#000"
    />
    <line
      fill="none"
      x1="485.90772"
      y1="675.57521"
      x2="549.31112"
      y2="675.57521"
      id="svg_336"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1769.58817"
      y1="53.85561"
      x2="1769.58817"
      y2="119.77832"
      id="svg_19"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <text
      fill="#000000"
      stroke="#000"
      x="537.90117"
      y="776.33248"
      id="svg_88"
      stroke-width="0"
      font-size="24"
      font-family="Noto Sans JP"
      text-anchor="start"
      xml:space="preserve"
    >
      Bathroom
    </text>
    <line
      fill="none"
      x1="1206.04154"
      y1="255.85829"
      x2="1206.04154"
      y2="54.69868"
      id="svg_261"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1207.11662"
      y1="387.95383"
      x2="1770.7448"
      y2="387.95383"
      id="svg_263"
      stroke="#000"
    />
    <line
      fill="none"
      x1="17.08416"
      y1="837.61743"
      x2="17.08416"
      y2="277.46217"
      id="svg_601"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1714.38817"
      y1="869.3908"
      x2="1769.84473"
      y2="869.3908"
      id="svg_604"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="724.92504"
      y1="867.96223"
      x2="1085.80065"
      y2="867.96223"
      id="svg_605"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1771.01674"
      y1="783.85361"
      x2="1771.01674"
      y2="869.08184"
      id="svg_607"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1769.58817"
      y1="596.71125"
      x2="1769.58817"
      y2="780.51067"
      id="svg_608"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
      stroke-dasharray="5,5"
    />
    <line
      fill="none"
      x1="1206.04154"
      y1="387.55048"
      x2="1206.04154"
      y2="343.60138"
      id="svg_707"
      stroke="#000"
    />
    <line
      fill="none"
      x1="18.24929"
      y1="52.33351"
      x2="283.16021"
      y2="52.33351"
      id="svg_809"
      stroke="#000"
    />
    <line
      fill="none"
      x1="900.39819"
      y1="52.3674"
      x2="287.95132"
      y2="52.3674"
      id="svg_1031"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1714.38817"
      y1="52.53678"
      x2="1769.84473"
      y2="52.53678"
      id="svg_1032"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1166.85239"
      y1="866.66916"
      x2="1166.85239"
      y2="504.69873"
      id="svg_1095"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1554.41406"
      y1="506.87278"
      x2="1768.04212"
      y2="506.87278"
      id="svg_1096"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1167.92755"
      y1="505.52143"
      x2="1416.69073"
      y2="505.52143"
      id="svg_1111"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1258.70885"
      y1="867.96223"
      x2="1707.42231"
      y2="867.96223"
      id="svg_1112"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1095.65328"
      y1="867.86493"
      x2="1252.25403"
      y2="867.86493"
      id="svg_1113"
      stroke="#000"
    />
    <line
      fill="none"
      x1="682.88962"
      y1="868.44538"
      x2="682.88962"
      y2="676.94303"
      id="svg_1174"
      stroke="#000"
    />
    <line
      fill="none"
      x1="485.59231"
      y1="868.44538"
      x2="485.59231"
      y2="676.94303"
      id="svg_1175"
      stroke="#000"
    />
    <line
      fill="none"
      x1="622.39422"
      y1="676.92656"
      x2="683.09492"
      y2="676.92656"
      id="svg_1176"
      stroke="#000"
    />
    <line
      fill="none"
      x1="91.1412"
      y1="870.66494"
      x2="411.47627"
      y2="870.66494"
      id="svg_1177"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="17.35135"
      y1="869.3908"
      x2="88.06304"
      y2="869.3908"
      id="svg_1178"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="17.08416"
      y1="273.17324"
      x2="17.08416"
      y2="51.94106"
      id="svg_1299"
      stroke="#000"
    />
    <line
      fill="none"
      x1="228.83553"
      y1="226.55344"
      x2="228.83553"
      y2="172.88894"
      id="svg_1563"
      stroke="#000"
    />
    <line
      fill="none"
      x1="228.83553"
      y1="104.93181"
      x2="228.83553"
      y2="51.2673"
      id="svg_1564"
      stroke="#000"
    />
    <text
      fill="#000000"
      stroke="#000"
      x="74.38762"
      y="147.95405"
      id="svg_1565"
      stroke-width="0"
      font-size="24"
      font-family="Noto Sans JP"
      text-anchor="start"
      xml:space="preserve"
    >
      Bathroom
    </text>
    <line
      fill="none"
      x1="1712.56033"
      y1="52.3674"
      x2="1279.84331"
      y2="52.3674"
      id="svg_1566"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1102.22591"
      y1="52.53678"
      x2="1275.25007"
      y2="52.53678"
      id="svg_1567"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1769.58817"
      y1="351.15296"
      x2="1769.58817"
      y2="588.69725"
      id="svg_1568"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <line
      fill="none"
      x1="1769.58817"
      y1="123.73824"
      x2="1769.58817"
      y2="345.37551"
      id="svg_1569"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke-dasharray="5,5"
      stroke="#000"
    />
    <line
      fill="none"
      x1="906.27997"
      y1="52.53678"
      x2="991.46627"
      y2="52.53678"
      id="svg_1570"
      stroke-linejoin="undefined"
      stroke-linecap="undefined"
      stroke="#000"
    />
    <g id="meeting_room">
      <rect
        fill="#f2efef"
        x="1282.25666"
        y="607.65519"
        width="391.20057"
        height="170.36876"
        id="svg_610"
        rx="8"
        stroke="#000"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1419.13631"
        y="633.94245"
        width="115.55446"
        height="115.55446"
        id="svg_611"
        rx="8"
      />
      <rect
        :fill="
          occupiedDesks.includes('b95d4035-13dc-4e75-8424-3b88684de5f8') ||
          userType !== 'BUSINESS'
            ? 'red'
            : 'green'
        "
        x="1422.83998"
        y="637.64612"
        width="108.14713"
        height="108.14713"
        id="svg_612"
        rx="8"
        stroke="#000"
        data-id="b95d4035-13dc-4e75-8424-3b88684de5f8"
        @click="handleMeetingRoomClick"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1299.04548"
        y="585.80767"
        width="43.74976"
        height="21.24988"
        id="svg_614"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1372.79507"
        y="585.80767"
        width="43.74976"
        height="21.24988"
        id="svg_615"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1447.79466"
        y="585.80767"
        width="43.74976"
        height="21.24988"
        id="svg_616"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1364.85627"
        y="778.30661"
        width="43.74976"
        height="21.24988"
        id="svg_619"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1438.60586"
        y="778.30661"
        width="43.74976"
        height="21.24988"
        id="svg_620"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1513.60545"
        y="778.30661"
        width="43.74976"
        height="21.24988"
        id="svg_621"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1256.47833"
        y="662.90181"
        width="24.99986"
        height="48.74973"
        id="svg_623"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1673.97659"
        y="667.15859"
        width="24.99986"
        height="48.74973"
        id="svg_624"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1527.5244"
        y="585.80767"
        width="43.74976"
        height="21.24988"
        id="svg_1093"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1586.98386"
        y="779.05093"
        width="43.74976"
        height="21.24988"
        id="svg_1094"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1600.49737"
        y="585.80767"
        width="43.74976"
        height="21.24988"
        id="svg_1561"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1299.9914"
        y="779.65796"
        width="43.74976"
        height="21.24988"
        id="svg_1562"
        rx="8"
      />
    </g>
    <g id="meeting_room">
      <rect
        fill="#f2efef"
        x="1333.60813"
        y="125.22273"
        width="354.71409"
        height="170.36876"
        id="svg_1097"
        rx="8"
        stroke="#000"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1455.62293"
        y="152.86134"
        width="115.55446"
        height="115.55446"
        id="svg_1098"
        rx="8"
      />
      <rect
        :fill="
          occupiedDesks.includes('52e6239b-e3ff-4bfb-b4f1-4f6f8ab6e296') ||
          userType !== 'BUSINESS'
            ? 'red'
            : 'green'
        "
        x="1459.3266"
        y="156.56501"
        width="108.14713"
        height="108.14713"
        id="svg_1099"
        rx="8"
        stroke="#000"
        data-id="52e6239b-e3ff-4bfb-b4f1-4f6f8ab6e296"
        @click="handleMeetingRoomClick"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1377.42399"
        y="103.37521"
        width="43.74976"
        height="21.24988"
        id="svg_1100"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1451.17358"
        y="103.37521"
        width="43.74976"
        height="21.24988"
        id="svg_1101"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1526.17317"
        y="103.37521"
        width="43.74976"
        height="21.24988"
        id="svg_1102"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1379.72126"
        y="295.87415"
        width="43.74976"
        height="21.24988"
        id="svg_1103"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1453.47085"
        y="295.87415"
        width="43.74976"
        height="21.24988"
        id="svg_1104"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1528.47044"
        y="295.87415"
        width="43.74976"
        height="21.24988"
        id="svg_1105"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1307.82981"
        y="185.87476"
        width="24.99986"
        height="48.74973"
        id="svg_1106"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1688.84158"
        y="184.72613"
        width="24.99986"
        height="48.74973"
        id="svg_1107"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1605.90291"
        y="103.37521"
        width="43.74976"
        height="21.24988"
        id="svg_1109"
        rx="8"
      />
      <rect
        fill="#f2efef"
        stroke="#000"
        x="1601.84885"
        y="296.61847"
        width="43.74976"
        height="21.24988"
        id="svg_1110"
        rx="8"
      />
    </g>

    <Desk
      v-for="desk in desks"
      :desk="desk"
      :key="desk.id"
      @deskClicked="$emit('deskClicked', $event)"
      :isOccupied="occupiedDesks.includes(desk.id)"
      :hasRequests="filteredDesks.includes(desk.id)"
    ></Desk>
  </svg>
</template>
<script>
/**
 * Component for displaying a specific floor layout within a building.
 * This component renders an interactive SVG diagram of a floor with desks and meeting rooms,
 * allowing users to view and select workstations or meeting rooms for booking.
 *
 * Features:
 * - Renders a detailed SVG floor plan based on provided floor data.
 * - Supports interactive selection of desks and meeting rooms.
 * - Highlights desks based on occupancy and specific user requests like equipment needs or window preference.
 * - Emits events for desk or room selection to facilitate booking actions in parent components.
 *
 * Props:
 * @vue-prop {Object} floorInfo - Contains details about the floor, including IDs and structural data.
 * @vue-prop {Array} occupiedDesks - A list of desk IDs that are currently occupied.
 * @vue-prop {String} userType - The type of the user, which influences access levels to certain areas like meeting rooms.
 * @vue-prop {String|null} equipment - Specifies equipment requirements for filtering desks.
 * @vue-prop {Boolean|null} hasWindow - Specifies if the desk should have a window based on user preference.
 *
 * Data:
 * @vue-data {Array} desks - Stores the list of desks on the current floor as retrieved from the server.
 * @vue-data {Array} filteredDesks - Stores desks that meet specific criteria like equipment and window preferences.
 *
 * Watchers:
 * - Watches `equipment` and `hasWindow` properties to re-filter the desks whenever these preferences change.
 *
 * Usage:
 * Embed this component in any part of the application where an interactive floor plan is needed for desk booking.
 * Ensure that the parent component manages state such as user type and booking preferences to pass them as props.
 *
 * @subcategory components / Building 2
 */

export default {
  props: {
    floorInfo: {
      type: Object,
      required: true,
    },
    occupiedDesks: {
      type: Array,
    },
    userType: {
      type: String,
    },
    equipment: {
      type: String,
    },
    hasWindow: {
      type: Boolean,
    },
  },
  data() {
    return {
      desks: [],
      filteredDesks: [],
    };
  },
  beforeMount() {
    this.getDesks();
    this.getFilteredDesks();
  },
  methods: {
    /**
     * Fetches and filters the desks on the current floor based on the type "desk".
     * This method makes an API call to retrieve a list of all workstations on the current floor and filters out those
     * which are specifically designated as desks. It updates the `desks` data property with these filtered results.
     */
    getDesks() {
      this.$ApiService
        .get_workstations(this.floorInfo.floorId, this.floorInfo.buildingId)
        .then((response) => {
          this.desks = response.data.workStationResourceList.filter(
            (desk) => desk.type === "desk",
          );
        });
    },
    /**
     * Filters desks based on user-specified equipment and window preferences.
     * This method is triggered whenever the `equipment` or `hasWindow` props change. It performs an API call
     * to fetch workstations that meet the specified criteria. If no equipment is specified, it filters based on the
     * window preference alone. The results are used to update the `filteredDesks` data property.
     */
    getFilteredDesks() {
      this.$ApiService
        .get_workstations(
          this.floorInfo.floorId,
          this.floorInfo.buildingId,
          this.equipment,
          this.hasWindow,
        )
        .then((response) => {
          if (this.equipment === null) {
            response.data.workStationResourceList =
              response.data.workStationResourceList.filter((desk) => {
                if (this.hasWindow !== null)
                  return desk.presentWindow === this.hasWindow;
                else return false;
              });
          }
          this.filteredDesks = response.data.workStationResourceList.map(
            (desk) => desk.id,
          );
        });
    },
    /**
     * Handles user interactions with meeting rooms within the SVG floor plan.
     * When a meeting room is clicked, this method checks if the user type is allowed to book meeting rooms
     * (e.g., 'BUSINESS' users). It emits an `deskClicked` event with the meeting room's ID if the room is available
     * and the user is permitted, allowing the parent component to process the booking.
     *
     * @param {Event} event - The DOM event triggered when a meeting room element in the SVG is clicked.
     */
    handleMeetingRoomClick(event) {
      if (this.userType === "BUSINESS") {
        const meetingRoomId = event.target.getAttribute("data-id");
        if (meetingRoomId && !this.occupiedDesks.includes(meetingRoomId)) {
          this.$emit("deskClicked", meetingRoomId);
        }
      }
    },
  },
  watch: {
    equipment: "getFilteredDesks",
    hasWindow: "getFilteredDesks",
  },
};
</script>
